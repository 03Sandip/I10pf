<!-- partials/articles.html -->
<section class="container section" id="articles-section">
  <h3 class="section-title">Latest Articles</h3>

  <div class="article-slider" id="articleSlider" aria-roledescription="carousel">
    <div class="slider-viewport">
      <div class="slider-track" id="sliderTrack" aria-live="polite"></div>
    </div>

    <button class="arrow left" id="prevArticle" aria-label="Previous article">&#9664;</button>
    <button class="arrow right" id="nextArticle" aria-label="Next article">&#9654;</button>

    <div class="dots" id="sliderDots" aria-hidden="false"></div>
  </div>

  <!-- Modal for full article -->
  <div class="article-modal-backdrop" id="articleModalBackdrop" role="dialog" aria-modal="true" style="display:none;">
    <div class="article-modal" role="document">
      <button id="closeArticleModal" class="close-btn" aria-label="Close">✕</button>
      <h2 id="modalArticleTitle" class="modal-title"></h2>
      <div id="modalArticleDate" class="modal-date"></div>
      <div id="modalArticleImage" class="modal-image"></div>
      <div id="modalArticleBody" class="modal-body"></div>
    </div>
  </div>
</section>

<!-- Article data file (loader will adjust path if necessary) -->
<script src="./js/articles.js"></script>

<!-- Initialization script (will run after js/articles.js has loaded because loader awaits external scripts) -->
<script>
(function initArticlesPartial(){
  const list = window.articles || [];
  const track = document.getElementById('sliderTrack');
  const dotsWrap = document.getElementById('sliderDots');
  const prevBtn = document.getElementById('prevArticle');
  const nextBtn = document.getElementById('nextArticle');

  if(!track) return;

  if(!list.length) {
    track.innerHTML = '<div style="padding:18px;font-style:italic;color:#666">No articles found. Edit js/articles.js to add articles.</div>';
    return;
  }

  const escapeHtml = (text) => (!text ? '' : String(text).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])));
  const wordsSlice = (t, s=0, e) => { if(!t) return ''; const w = t.split(/\s+/); return w.slice(s,e).join(' '); };
  const snippet = (str,len) => str ? (str.length > len ? str.slice(0,len).trim() + '…' : str) : '';

  track.innerHTML = '';
  dotsWrap.innerHTML = '';

  list.forEach((article, idx) => {
    const card = document.createElement('div');
    card.className = 'article-card';
    card.setAttribute('data-index', idx);
    card.innerHTML = `
      <div class="thumb"><img src="${escapeHtml(article.image||'')}" alt="${escapeHtml(article.title||'')}"></div>
      <div class="info">
        <div class="article-date">${escapeHtml(article.date||'')}</div>
        <h3 class="article-title">
          <span class="hl-yellow">${escapeHtml(wordsSlice(article.title,0,3))}</span>
          <span class="hl-blue">${escapeHtml(wordsSlice(article.title,3))}</span>
        </h3>
        <p class="article-excerpt">${escapeHtml(article.excerpt || snippet(article.content||'', 160))}</p>
        <button class="read-btn" data-id="${idx}" aria-label="Read more about ${escapeHtml(article.title||'')}">Read More</button>
      </div>
    `;
    track.appendChild(card);

    const dot = document.createElement('div');
    dot.className = 'dot';
    dot.dataset.id = idx;
    dotsWrap.appendChild(dot);
  });

  const cards = Array.from(track.children);
  let index = 0;
  const total = cards.length;

  function update(animate=true){
    const cardWidth = cards[0]?.getBoundingClientRect().width || 760;
    const gap = 20;
    const translateX = index * (cardWidth + gap);
    track.style.transition = animate ? 'transform .45s cubic-bezier(.22,.9,.25,1)' : 'none';
    track.style.transform = `translateX(-${translateX}px)`;
    dotsWrap.querySelectorAll('.dot').forEach(d=> d.classList.toggle('active', +d.dataset.id === index));
    if(!animate) requestAnimationFrame(()=> requestAnimationFrame(()=> track.style.transition = 'transform .45s cubic-bezier(.22,.9,.25,1)'));
  }

  prevBtn && prevBtn.addEventListener('click', ()=> { index = (index - 1 + total) % total; update(); resetAutoplay(); });
  nextBtn && nextBtn.addEventListener('click', ()=> { index = (index + 1) % total; update(); resetAutoplay(); });

  dotsWrap.addEventListener('click', e => {
    const d = e.target.closest('.dot');
    if(!d) return;
    index = +d.dataset.id;
    update();
    resetAutoplay();
  });

  // Modal wiring
  const modalBackdrop = document.getElementById('articleModalBackdrop');
  const closeModalBtn = document.getElementById('closeArticleModal');

  track.addEventListener('click', e => {
    const btn = e.target.closest('.read-btn');
    if(!btn) return;
    const id = +btn.dataset.id;
    const a = list[id];
    if(!a) return;
    document.getElementById('modalArticleTitle').textContent = a.title || '';
    document.getElementById('modalArticleDate').textContent = a.date || '';
    document.getElementById('modalArticleImage').innerHTML = a.image ? `<img src="${escapeHtml(a.image)}" alt="${escapeHtml(a.title||'')}">` : '';
    document.getElementById('modalArticleBody').innerHTML = a.content ? escapeHtml(a.content).replace(/\n/g,'<br>') : (a.excerpt || '');
    modalBackdrop.style.display = 'flex';
    closeModalBtn && closeModalBtn.focus();
  });

  closeModalBtn && closeModalBtn.addEventListener('click', ()=> modalBackdrop.style.display = 'none');
  modalBackdrop && modalBackdrop.addEventListener('click', e => { if(e.target === modalBackdrop) modalBackdrop.style.display = 'none'; });
  document.addEventListener('keydown', e => { if(e.key === 'Escape') modalBackdrop && (modalBackdrop.style.display = 'none'); });

  // Autoplay + swipe
  let autoplay = setInterval(()=> { index = (index + 1) % total; update(); }, 4200);
  function resetAutoplay(){ clearInterval(autoplay); autoplay = setInterval(()=> { index = (index + 1) % total; update(); }, 4200); }

  const sliderEl = document.getElementById('articleSlider');
  if(sliderEl){
    sliderEl.addEventListener('mouseenter', ()=> clearInterval(autoplay));
    sliderEl.addEventListener('mouseleave', ()=> resetAutoplay());
  }

  (function addSwipe(){
    let startX=0, dx=0, isTouch=false;
    const vp = document.querySelector('.slider-viewport');
    vp && vp.addEventListener('touchstart', e => { isTouch=true; startX = e.touches[0].clientX; clearInterval(autoplay); });
    vp && vp.addEventListener('touchmove', e => {
      if(!isTouch) return;
      dx = e.touches[0].clientX - startX;
      track.style.transition = 'none';
      track.style.transform = `translateX(calc(-${index * (cards[0]?.getBoundingClientRect().width + 20 || 0)}px + ${-dx}px))`;
    });
    vp && vp.addEventListener('touchend', e => {
      isTouch=false;
      if(Math.abs(dx) > 70) { dx < 0 ? index = Math.min(total-1, index+1) : index = Math.max(0, index-1); }
      dx = 0;
      update();
      resetAutoplay();
    });
  })();

  // initial
  setTimeout(()=> update(false), 50);
  window.addEventListener('resize', ()=> update(false));
})();
</script>

<style>
/* Scoped styles for articles partial - improved centered layout + masking */
#articles-section{max-width:1100px;margin:36px auto;padding:18px;}
.section-title{font-family: Georgia, serif;font-size:28px;margin-bottom:18px;}

.article-slider{position:relative;background:#fff;border-radius:22px;padding:18px;box-shadow:0 8px 28px rgba(0,0,0,0.06);overflow:visible;}
.slider-viewport{overflow:hidden; position:relative;}

/* soft gradient masks on left & right to hide peeking artwork */
.slider-viewport::before,
.slider-viewport::after{
  content:"";
  position:absolute;
  top:0;
  bottom:0;
  width:8%;
  pointer-events:none;
  z-index:10;
}
.slider-viewport::before{
  left:0;
  background: linear-gradient(90deg, rgba(255,255,255,1) 0%, rgba(255,255,255,0.9) 40%, rgba(255,255,255,0) 100%);
}
.slider-viewport::after{
  right:0;
  background: linear-gradient(270deg, rgba(255,255,255,1) 0%, rgba(255,255,255,0.9) 40%, rgba(255,255,255,0) 100%);
}

.slider-track{
  display:flex;
  gap:20px;
  transition:transform .45s cubic-bezier(.22,.9,.25,1);
  will-change:transform;
  padding:6px 0; /* left/right padding will be set dynamically in JS to center the active card */
  align-items:center;
}

/* card */
.article-card{
  box-sizing:border-box;
  min-width:760px;  /* desktop target width */
  max-width:760px;
  display:flex;
  gap:22px;
  align-items:center;
  background:transparent;
  border-radius:12px;
  padding:14px;
  position:relative;
}

/* left image */
.thumb{width:320px;height:320px;border-radius:16px;overflow:hidden;flex-shrink:0;box-shadow:0 6px 18px rgba(0,0,0,0.06);}
.thumb img{width:100%;height:100%;object-fit:cover;display:block;border-radius:12px;}

/* content column */
.info{flex:1;padding-right:10px;}
.article-date{font-size:13px;color:#6b6b6b;margin-bottom:10px;}
.article-title{font-size:34px;line-height:1.05;font-family:Georgia, serif;margin:0 0 12px; max-width:100%;}
.hl-yellow{background:#fff7b2;padding:0 6px;border-radius:3px;}
.hl-blue{background:#cceeea;padding:0 6px;border-radius:3px;margin-left:8px;}
.article-excerpt{color:#444;margin-bottom:14px;max-width:520px;}
.read-btn{display:inline-flex;align-items:center;padding:10px 18px;background:#111;color:#fff;border-radius:10px;border:none;cursor:pointer;font-weight:600;}

/* arrows */
.arrow{position:absolute;top:50%;transform:translateY(-50%);width:44px;height:44px;border-radius:10px;background:rgba(0,0,0,0.06);display:flex;align-items:center;justify-content:center;cursor:pointer;border:none;z-index:20;}
.arrow.left{left:12px;}
.arrow.right{right:12px;}
.arrow:hover{background:rgba(0,0,0,0.10);}

/* dots */
.dots{display:flex;gap:8px;justify-content:center;margin-top:14px;}
.dot{width:10px;height:10px;border-radius:999px;background:#dcdcdc;cursor:pointer;}
.dot.active{background:#111;transform:scale(1.05);}

/* Modal */
.article-modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;padding:20px;z-index:9999;}
.article-modal{background:#fff;border-radius:10px;max-width:880px;width:100%;max-height:86vh;overflow:auto;padding:20px;box-sizing:border-box;}
.close-btn{float:right;border:none;background:transparent;font-size:20px;cursor:pointer;}
.modal-title{font-family:Georgia,serif;font-size:24px;margin-top:0;}
.modal-date{color:#666;margin-bottom:12px;}
.modal-image{width:100%;height:360px;border-radius:8px;overflow:hidden;margin-bottom:12px;}
.modal-image img{width:100%;height:100%;object-fit:cover;display:block;}
.modal-body{color:#333;line-height:1.6;white-space:pre-wrap;font-size:15px;}

/* responsive adjustments */
@media (max-width:1100px){
  .article-card{min-width:640px;max-width:640px;}
  .thumb{width:300px;height:300px;}
}
@media (max-width:880px){
  .article-card{min-width:92%;max-width:92%;flex-direction:column;align-items:flex-start;gap:12px;padding:12px;}
  .thumb{width:100%;height:220px;border-radius:10px;}
  .article-title{font-size:24px;}
  .slider-viewport::before, .slider-viewport::after{display:none;} /* tiny screens: remove mask */
  .arrow.left,.arrow.right{display:none;}
}
</style>